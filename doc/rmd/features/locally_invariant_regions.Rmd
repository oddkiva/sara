## Geometric Characteristics of a Locally Invariant Region

In general any locally invariant regions, *a.k.a.* features, present a common
set of geometric characteristics, be it SIFT, SURF, MSER, or Harris-Affine etc.
We will detail these in the sequel. Now in practice, in multiple view geometry
and structure-from-motion, they tend to be viewed as mere points in the images
but they are actually much more than that.

Before moving forward in this chapter, let us denote a feature by the italic
text letter $x$ for convenience.

More than just being a point indeed, a feature $x$ is fully characterized by:

- a center with pixel coordinates $\x \in \mathbb{R}^2$,
  which structure-from-motion pipelines only utilize,

- a shape $\Shape_x$, which represents the (possibly anisotropic) scale of
  feature $x$ and can be summarized^[MSER is a special case as I'll explain
  further below] as an ellipse as follows:

  \begin{equation}
    \Shape_x \eqdef \left\{ \x' \in \mathbb{R}^2\ \left|\ (\x'-\x)^T \bSigma_x
  (\x'-\x) \leq 1 \right. \right\},
  \end{equation}

  where $\bSigma_x \in \mathbb{R}^{2\times 2}$ is a scale matrix.

- a dominant gradient orientation $\theta_x$ if it is calculated.

With these information in mind, we can derive the following definition^[I doubt
you will see this definition anywhere else, so this is my small innovation.].

:::puzzle
```{definition, name="Scale-Normalized Signed Distance Function"}
The scale matrix $\bSigma_x$ also allows to define a *scale-normalized signed
distance function* to $x$:

\begin{equation}
  d_x(\x') \eqdef (\x' - \x)^T \bSigma (\x' - \x) - 1,
\end{equation}

where the zero level set is the *elliptic* shape of the feature.
```
:::

Let us illustrate some kinds of feature that have been used in previous research.

### Locally Similar-Invariant Features

An example of a SIFT feature is illustrated in Figure \@ref(fig:sift-feature).
To be more accurate, what SIFT detects are *local extrema of Difference of
Gaussians*, which we term simply as DoG for brevity. By design, a DoG feature is
circular and only guarantees invariance to similarity transforms
(scale+rotation) in contrast to other affine invariant features presented in
[@MikolajczykTSZMSKVG:2005:ijcv].

```{r sift-feature, echo=FALSE, fig.align='center', fig.cap="Geometric characteristics of a SIFT feature. Credits: http://www.vlfeat.org/overview/sift.html."}

knitr::include_graphics(paste0(getwd(), "/feature.png"))
```

Other similarity-invariant detectors enjoy the same similarity invariance as
SIFT. Let us cite for example: SURF [@BayETVG:2008:cviu], Edge Foci
[@ZitnickR:2011:iccv], SFOP [@ForstnerDS:2009:iccv]. I don't know much about
them but I really like the elegant geometric properties that SFOP and Edge Foci
enjoy.^[And I should study them someday.]

### Locally Affine-Invariant Features

In contrast to DoG-SIFT keypoints, the shape of affine-covariant feature are
elliptic, which are obtained with affine shape adaptation. Without going into
details about this additional algorithmic procedure, we will just illutrate such
features with Figure \@ref(fig:affine-covariant-regions).

```{r affine-covariant-regions, echo=FALSE, fig.align='center', fig.cap="Locally Affine-Invariant Features. Credits: [@MikolajczykTSZMSKVG:2005:ijcv]"}

knitr::include_graphics(paste0(getwd(), "/AffineCovariantRegions.png"))
```

Now in practice, I found that any feature can still performs very well without
the affine shape adaptation [@MikolajczykTSZMSKVG:2005:ijcv].  I found it adds
quite a computational burden and is very tricky to implement^[I am not sure I
got it right in my implementation attempts].


### MSER: A Special Case.

In fact, MSER features [@MatasCUP:2002:bmvc] are more than just an elliptic
shape: they are a set of connected pixels. That allows us to represent a much
richer set of shapes, and we can use them for letter recognition. See for
example [@GomezK:2014:icpr].

As I carefully said it above, a MSER feature is *summarized* more compactly as
an elliptic region by calculating a second-order moment matrix. To do so, we
cumulate the locations of all the pixels $\mathbf{x}'$ in the MSER as follows:

\begin{equation}
  \bSigma_x^{-1} = \frac{1}{\mathrm{area}(x)}
  \displaystyle \int (\x' \x'^T - \x \x^T) \mathop{d}\x'
\end{equation}

The reason for which I use the integral $\int$ was to avoid the confusion with
the discrete sum symbol $\sum$ with the scale symbol $\bSigma$.

Implementation-wise, denoting the $x$- and $y$-coordinates of each 2D vector by
$\x_u$ and $\x_v$, this is simply the following discrete sums:

\begin{equation}
  \bSigma_x^{-1} = \frac{1}{\mathrm{area}(x)}
  \begin{bmatrix}
    \displaystyle \sum_{\mathbf{x}'} (\mathbf{x}'_u - \mathbf{x}_u)^2 &
    %
    \displaystyle \sum_{\mathbf{x}'}
      (\mathbf{x}'_u \mathbf{x}'_v - \mathbf{x}_u \mathbf{x}_v)^2 \\
    %
    \displaystyle \sum_{\mathbf{x}'}
      (\mathbf{x}'_u \mathbf{x}'_v - \mathbf{x}_u \mathbf{x}_v)^2 &
    %
    \displaystyle \sum_{\mathbf{x}'} (\mathbf{x}'_v - \mathbf{x}_v)^2
  \end{bmatrix},
\end{equation}

the second-order moment matrix being also the inverse of the scale matrix.

### Personal Conclusion

I conclude this section with a personal (biased) note since I am a SIFT fan.

Despite the advances in feature detection, SIFT remains a very good option.
Besides the SIFT patent has expired, so we can use it! The default parameters
that comes with it are so good and well validated over the past research
literature and should parameter tuning becomes necessary, it is very to do so as
I found them very easy to interpret.

Although only similarity-invariant, SIFT still performs very well compared to
affine-covariant regions in my experience. My main complaint is the messiness I
have to deal after the detection. Usually, I have to filter them with non-maxima
suppression to remove clusters of features.^[Sorry for being too critical... but
yes I was a long-time user of affine-covariant features.]

That is not the case with SIFT, MSER where the keypoints are very distinctive.
