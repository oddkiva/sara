## Camera Resectioning

The camera resectioning is another important problem that is solved in
Structure-from-Motion.

### Problem Statement

In this problem we assume that a set of 2D image points $\{ \mathbf{u}_i \}_i$
in an image $I$ are known to respectively correspond to a set of 3D scene points
$\{ \mathbf{x}_i\}$ in some reference frame.

Our goal is to retrieve the camera parameters that formed this very image $I$,
namely the camera pose, that is its gaze orientation $\mathbf{R}$ and position
$\mathbf{t}$ with respect to a reference frame, say, an arbitrary world frame
$\mathcal{W}$.

There are two situations in Structure-from-Motion:

1. we do not know the camera intrinsic parameters but we do know that the
   mathematical camera model that can explain the formation of image $I$ is the
   pinhole camera model, or a camera model that can account for moderate
   distortion model;
2. we do know which mathematical camera model explains best the formation of
   image $I$ and the parameter value of this camera model.

### First Situation

The first situation can be solved by means of standard linear algebra.
Specifically the calibration software Bundler [@SnavelySS:2008:ijcv] uses
[@HartleyZ:2003:mvg]'s Direct Linear Transform (DLT) method to find a good guess
of the camera pose. After which, a bundle adjustment will refine the pose
$(\mathbf{R}, \mathbf{t})$ of the camera and its intrinsic parameters, which
include the calibration matrix $\mathbf{K}$ and the distortion coefficients.

### Second Situation: the PnP problem.

The second situation can be solved via Perspective-N-Point methods. Indeed,
because we know the camera model and its parameters, we can calculate for each
image point $\mathbf{u}_i$ its corresponding incident 3D light ray vector
$\mathrm{ray}(\mathbf{u}_i) = \mathbf{y}_i$ with coordinates expressed in the
camera frame $\mathcal{C}$.

For example, in the simple pinhole camera model with known calibration matrix
$\mathbf{K}$, the homogeneous film coordinates $\mathbf{K}^{-1} \begin{bmatrix}
\mathbf{x}_i \\ 1 \end{bmatrix}$ also corresponds to the backprojected light ray
$\mathbf{y}_i$.

The camera resectioning problem starts from the observation that any rigid body
motion preserves the Euclidean distance $||\mathbf{x}_i - \mathbf{x}_j||_2$ for
any pair of 3D scene points $\mathbf{x}_i$ and $\mathbf{x}_j$. In particular,
this is true for the camera pose $(\mathbf{R}, \mathbf{t})$.

The camera resectioning then consists in determining the appropriate scale
$\lambda_i$ to each backprojected ray $\mathbf{y}_i$ so the change of coordinate
via the rigid body motion $(\mathbf{R}, \mathbf{t})$ still preserves the
distances.

\begin{equation}
  ||\lambda_i \mathbf{y}_i - \lambda_j \mathbf{y}_j||_2 =
  ||\mathbf{x}_i - \mathbf{x}_j||_2
\end{equation}

Additionally we know that
\begin{equation}
  \lambda_i \mathbf{y}_i = \mathbf{R} \mathbf{x}_i + \mathbf{t}
\end{equation}

:::fyi
One caveat to avoid further confusion, notice that in the PnP problem:

- $\mathbf{R}$ actually expresses the axes of the world frame $\mathcal{W}$ with
  respect to the camera frame $\mathcal{C}$.
- $\mathbf{t}$ actually expresses the position of the world origin in the camera frame.

Not the other way around.
:::

Let us assume for a moment that we know each scale $\lambda_i$. We are then able
to completely determine the rotation $\mathbf{R}$ from the three direction
vectors, say

\begin{equation}
  \left\{
  \begin{array}{c}
    \mathbf{z}_{12} = \lambda_1 \mathbf{y}_1 - \lambda_2 \mathbf{y}_2 \\
    \mathbf{z}_{13} = \lambda_1 \mathbf{y}_1 - \lambda_3 \mathbf{y}_3 \\
    \mathbf{z}_{23} = \lambda_1 \mathbf{y}_2 - \lambda_3 \mathbf{y}_3
  \end{array}
  \right.,
\end{equation}

since the three of these satisfy

\begin{equation}
  \mathbf{z}_{ij} = \mathbf{R} (\mathbf{x}_i - \mathbf{x}_j)
\end{equation}

This can be rewritten as the matrix system:
\begin{equation}
  \mathbf{Z} = \mathbf{R} \mathbf{X}
\end{equation}

Under the assumption that the three scene points $\mathbf{x}_i$ are not
collinear, the matrix $\mathbf{X}$ is then invertible, thus yielding

\begin{equation}
  \mathbf{R} = \mathbf{Z} \mathbf{X}^{-1},
\end{equation}

And we can finally deduce $\mathbf{t}$ a posteriori since

\begin{equation}
  \mathbf{t} = \lambda_i \mathbf{y}_i - \mathbf{R} \mathbf{x}_i
\end{equation}

In my readings, I have learnt that the first method ever devised was discovered
by Grunert in 1841, who solved it for the case $N = 3$ (TODO CITE).

I won't try to review the literature exhaustively but let us quickly mention
that more recent methods have been proposed in the computer vision literature
for the general case (EPnP, UPnP to be cited) or for other particular case $N =
4$ (Quan and Lan).

Over the years, more recent P3P methods have been proposed and more efficient to
compute. We will focus on reviewing Lambda-Twist [@PerssonN:2018:eccv], which is
one of the fastest P3P method if not the fastest as of 2021.

### Lambda-Twist: a fast P3P solver.

Without loss of generality, Lambda-Twist assumes that each backprojected ray
$\mathbf{y}_i$ have unit norm, *i.e.*, $||\mathbf{y}_i||_2 = 1$, which otherwise
we renormalize as a preprocessing step.

Lambda-Twist solves the P3P problems and starts by squaring the distance
invariants, which yields the following remarkable identity:

\begin{equation}
  \lambda_i^2 + \lambda_j^2 - 2 \mathbf{y}_i^T \mathbf{y}_j \lambda_i \lambda_j
  = || \mathbf{x}_i - \mathbf{x}_j ||_2^2
\end{equation}

[@PerssonN:2018:eccv] introduces the following notations by denoting the
Euclidean squared distance by
\begin{equation}
  a_{ij} = || \mathbf{x}_i - \mathbf{x}_j ||_2^2,
\end{equation}
and the cosine of the angle between each backprojected light rays by
\begin{equation}
  b_{ij} = \mathbf{y}_i^T \mathbf{y}_j
\end{equation}

We can rewrite these into quadratic matrix form as
\begin{equation}
  \mathbf{\lambda}^T \mathbf{M}_{ij} \mathbf{\lambda} = a_{ij}
\end{equation}

where $\mathbf{\lambda} = \begin{bmatrix} \lambda_1 \\ \lambda_2 \\ \lambda_3
\end{bmatrix}$

and
\begin{equation}
  \mathbf{M}_{12} = \begin{bmatrix}
    1 & -b_{12} & 0 \\
    -b_{12} & 1 & 0 \\
    0 & 0 & 0 \\
  \end{bmatrix}
\end{equation}

\begin{equation}
  \mathbf{M}_{13} = \begin{bmatrix}
    1 & 0 & -b_{13} \\
    0 & 0 & 0 \\
    -b_{12} & 0 & 1 \\
  \end{bmatrix}
\end{equation}

\begin{equation}
  \mathbf{M}_{23} = \begin{bmatrix}
    0 & 0 & 0 \\
    0 & 1 & -b_{23} \\
    0 & -b_{12} & 1 \\
  \end{bmatrix}
\end{equation}

Let's spend some time observing these three matrices.

- Each of them represents parabolic, elliptic or hyperbolic cylinders since in
  the affine $\lambda$ 3-space, since the matrices are rank 2.
  In fact they are elliptic cylinders (parabolic in the worst case), since the
  discriminant of the conic is nonpositive.
  \begin{equation}
    B^2 - 4AC = 4 b_{ij}^2 - 4 \leq 0
  \end{equation}
  since the cosine of unit vectors $b_ij$ verifies $-1 \leq b_{ij} =
  \mathbf{y}_i^T \mathbf{y}_j \leq 1$
- the axis of each of these cylinders are mutually orthogonal as the zero column vector
  appears at different column index upon examination of the matrices.
